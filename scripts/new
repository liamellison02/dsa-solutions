#!/usr/bin/env bash
set -euo pipefail

if [ "$#" -lt 5 ]; then
  echo "Usage:"
  echo "  ./scripts/new <platform> <id> <slug> <lang> <pattern> [tags]"
  echo ""
  echo "Examples:"
  echo "  ./scripts/new lc 125 valid-palindrome cpp arrays_hashing/two_pointers palindrome,string"
  echo "  ./scripts/new cf 1791c prepend-append cpp arrays_hashing/two_pointers two-pointers,string"
  exit 1
fi

platform="$1" # lc | cf | ...
id="$2"
slug="$3"     # kebab-case
lang="$4"     # cpp | py
pattern="$5"  # arrays_hashing/two_pointers
tags="${6:-}" # optional, comma-separated

case "$lang" in
cpp) ext="cpp" ;;
py) ext="py" ;;
*)
  echo "Error: language must be 'cpp' or 'py'"
  exit 1
  ;;
esac

dir="problems/$pattern"
file="$dir/${platform}-${id}-${slug}.${ext}"

# template based on platform
tmpl="templates/${platform}.${ext}"
if [ ! -f "$tmpl" ]; then
  tmpl="templates/solution.${ext}"
fi

mkdir -p "$dir"

if [ -f "$file" ]; then
  echo "Error: file already exists:"
  echo "  $file"
  exit 1
fi

cp "$tmpl" "$file"

# sed (GNU/BSD-compatible)

if sed --version >/dev/null 2>&1; then
  # GNU sed (Linux, WSL)
  SED_INPLACE=(-i)
else
  # BSD sed (macOS)
  SED_INPLACE=(-i '')
fi

sed "${SED_INPLACE[@]}" "s|platform:|platform: $platform|" "$file"
sed "${SED_INPLACE[@]}" "s|id:|id: $id|" "$file"
sed "${SED_INPLACE[@]}" "s|name:|name: ${slug//-/ }|" "$file"
sed "${SED_INPLACE[@]}" "s|pattern:|pattern: $pattern|" "$file"
sed "${SED_INPLACE[@]}" "s|tags:|tags: $tags|" "$file"

echo "Created:"
echo "  $file"
echo "Template:"
echo "  $tmpl"
